name: CI Tests

on:
  pull_request:
    branches: [ main, master ]
  push:
    branches: [ main, master ]

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install ARM toolchain
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-arm-none-eabi binutils-arm-none-eabi
        
    - name: Verify toolchain installation
      run: |
        arm-none-eabi-gcc --version
        arm-none-eabi-ld --version
        
    - name: Build BCM2835 (RPi Zero/1)
      run: |
        cd build
        export BCM=2835
        make clean
        make
        ls -lh kernel7.img
        
    - name: Build BCM2836 (RPi 2)
      run: |
        cd build
        export BCM=2836
        make clean
        make
        ls -lh kernel7.img
        
    - name: Build BCM2837 (RPi 3) - 32-bit
      run: |
        cd build
        export BCM=2837
        make clean
        make || echo "BCM2837 requires aarch64 toolchain, skipping"
        
    - name: Run unit tests
      run: |
        cd tests
        python3 test_memory.py
        
    - name: Run integration tests
      run: |
        cd tests
        bash run_tests.sh
        
    - name: Check binary size
      run: |
        cd build
        export BCM=2836
        make clean
        make
        SIZE=$(stat -c%s kernel7.img)
        echo "Binary size: $SIZE bytes"
        if [ $SIZE -gt 100000 ]; then
          echo "Warning: Binary size exceeds 100KB (size: $SIZE bytes)"
        else
          echo "Binary size OK: $SIZE bytes"
        fi
        
    - name: Archive build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kernel-images
        path: build/kernel*.img
        retention-days: 30

  static-analysis:
    # Disable this job for now
    if: false
    name: Static Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check file formatting
      run: |
        # Check for trailing whitespace
        if grep -rn '[[:blank:]]$' src/ include/ --exclude-dir=build 2>/dev/null; then
          echo "Error: Found trailing whitespace"
          exit 1
        fi
        echo "No trailing whitespace found"
        
    - name: Check for TODO/FIXME comments
      run: |
        echo "Checking for TODO/FIXME comments..."
        grep -rn "TODO\|FIXME" src/ include/ || echo "No TODO/FIXME found"
        
    - name: Verify header guards
      run: |
        echo "Checking header guards..."
        for file in src/kernel/*.h; do
          if [ -f "$file" ]; then
            filename=$(basename "$file" .h | tr '[:lower:]' '[:upper:]' | tr '-' '_')
            if ! grep -q "#ifndef ${filename}_H" "$file" && ! grep -q "#ifndef.*_H" "$file"; then
              echo "Warning: Check header guard in $file"
            fi
          fi
        done
        echo "Header guard check completed"
        
    - name: Check code structure
      run: |
        echo "Verifying code structure..."
        # Check for required files
        required_files=(
          "src/kernel/main.c"
          "src/kernel/uart.c"
          "src/kernel/boot_display.c"
          "src/kernel/rom_loader.c"
          "src/kernel/syscall.c"
          "src/kernel/power.c"
          "src/kernel/audio.c"
          "src/aarch32/boot.S"
          "build/Makefile"
          "build/linker.ld"
        )
        
        missing_files=0
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "Error: Required file $file not found"
            missing_files=$((missing_files + 1))
          fi
        done
        
        if [ $missing_files -gt 0 ]; then
          echo "Error: $missing_files required file(s) missing"
          exit 1
        fi
        echo "All required files present"

  documentation-check:
    name: Documentation Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check README exists
      run: |
        if [ ! -f "README.md" ]; then
          echo "Error: README.md not found"
          exit 1
        fi
        echo "README.md found"
        
    - name: Check documentation files
      run: |
        docs=(
          "README.md"
          "CHANGELOG.md"
          "CONTRIBUTING.md"
          "docs/API.md"
          "docs/HARDWARE.md"
          "docs/ROM_DEVELOPMENT.md"
        )
        
        missing_docs=0
        for doc in "${docs[@]}"; do
          if [ -f "$doc" ]; then
            echo "✓ $doc exists"
          else
            echo "✗ $doc missing"
            missing_docs=$((missing_docs + 1))
          fi
        done
        
        if [ $missing_docs -gt 0 ]; then
          echo "Warning: $missing_docs documentation file(s) missing"
        fi
        
    - name: Verify README content
      run: |
        # Check if README contains key sections
        required_sections=(
          "Features"
          "Build"
          "Hardware"
          "ROM"
          "Holotape"
        )
        
        for section in "${required_sections[@]}"; do
          if grep -qi "$section" README.md; then
            echo "✓ README contains section about $section"
          else
            echo "⚠ README might be missing section about $section"
          fi
        done
